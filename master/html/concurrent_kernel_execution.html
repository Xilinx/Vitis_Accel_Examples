

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Concurrent Kernel Execution &mdash; Vitis Accel Examples&#39; Documentation 2019.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Copy Buffer" href="copy_buffer.html" />
    <link rel="prev" title="Host" href="host.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Vitis Accel Examples' Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="prerequisites.html">Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="shells.html">Supported Shells</a></li>
<li class="toctree-l1"><a class="reference internal" href="compile_execute.html">Compilation and Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
</ul>
<p class="caption"><span class="caption-text">Category of Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="hello_world.html">Hello World</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="host.html">Host</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Concurrent Kernel Execution</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#supported-shells">SUPPORTED SHELLS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#design-files">DESIGN FILES</a></li>
<li class="toctree-l3"><a class="reference internal" href="#command-line-arguments">COMMAND LINE ARGUMENTS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="copy_buffer.html">Copy Buffer</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_transfer.html">Data Transfer</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_query.html">Device Query (CPP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_query_cpp.html">Device Query (CPP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="debug_profile.html">Printing Profile Data and Dumping Waveform file</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors.html">Error Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="errors_cpp.html">Error Handling (CPP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="hbm_bandwidth.html">HBM Bandwidth</a></li>
<li class="toctree-l2"><a class="reference internal" href="hbm_simple.html">HBM Simple Vector Addition</a></li>
<li class="toctree-l2"><a class="reference internal" href="host_global_bandwidth.html">host_global</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiple_cus_asymmetrical.html">Vector Addition ~ Asymmetrical Multiple Compute Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="overlap.html">Overlap Host and HLS kernels</a></li>
<li class="toctree-l2"><a class="reference internal" href="streaming_host_bandwidth.html">Host Streaming Bandwidth</a></li>
<li class="toctree-l2"><a class="reference internal" href="streaming_k2k.html">Stream Kernel to Kernel Vector Addition and Multiplication</a></li>
<li class="toctree-l2"><a class="reference internal" href="streaming_k2k_mm.html">Stream Kernel to Kernel Vector Addition and Multiplication</a></li>
<li class="toctree-l2"><a class="reference internal" href="streaming_mm_mixed.html">Stream Vector Addition with OpenCL Buffers</a></li>
<li class="toctree-l2"><a class="reference internal" href="streaming_multi_cus.html">Stream Vector Addition (Multiple Compute Units)</a></li>
<li class="toctree-l2"><a class="reference internal" href="streaming_simple.html">Stream Kernel Simple Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cpp.html">C++ Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="sys_opt.html">System Optimization Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="rtl.html">RTL Kernels</a></li>
<li class="toctree-l1"><a class="reference internal" href="ocl.html">OpenCL Kernels</a></li>
</ul>
<p class="caption"><span class="caption-text">Common Utilities</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="common.html">Common Files</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Vitis Accel Examples' Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="host.html">Host</a> &raquo;</li>
        
      <li>Concurrent Kernel Execution</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/concurrent_kernel_execution.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="concurrent-kernel-execution">
<h1>Concurrent Kernel Execution<a class="headerlink" href="#concurrent-kernel-execution" title="Permalink to this headline">¶</a></h1>
<p>This example will demonstrate how to use multiple and out of order
command queues to simultaneously execute multiple kernels on an FPGA.</p>
<p><strong>KEY CONCEPTS:</strong> Concurrent execution, Out of Order Command Queues,
Multiple Command Queues</p>
<p><strong>KEYWORDS:</strong> CL_QUEUE_OUT_OF_ORDER_EXEC_MODE_ENABLE,
clSetEventCallback()</p>
<p>This example illustrates two ways to implement concurrent kernel
execution. 1. Multiple command enqueues 2. Single command queue with out
of order execution</p>
<p>Design contains 3 kernels <code class="docutils literal notranslate"><span class="pre">mscale</span></code>, <code class="docutils literal notranslate"><span class="pre">madd</span></code> and <code class="docutils literal notranslate"><span class="pre">mmult</span></code>. <code class="docutils literal notranslate"><span class="pre">madd</span></code>
needs to wait for <code class="docutils literal notranslate"><span class="pre">mscale</span></code> to complete but <code class="docutils literal notranslate"><span class="pre">mmult</span></code> can run
independently (no dependency).</p>
<p><code class="docutils literal notranslate"><span class="pre">multiple_command_queues</span></code> function creates two sequential command
queues, one for <code class="docutils literal notranslate"><span class="pre">mscale</span> <span class="pre">and</span> <span class="pre">madd</span></code> and other for <code class="docutils literal notranslate"><span class="pre">mmult</span></code>.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span><span class="o">::</span><span class="n">CommandQueue</span> <span class="n">ordered_queue1</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">CL_QUEUE_PROFILING_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="n">cl</span><span class="o">::</span><span class="n">CommandQueue</span> <span class="n">ordered_queue2</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">CL_QUEUE_PROFILING_ENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
</pre></div>
</div>
<p>Both Command queues are created as in-order execution. <code class="docutils literal notranslate"><span class="pre">msacle</span></code> and
<code class="docutils literal notranslate"><span class="pre">madd</span></code> are enqueued in first command queue one after another. As
Command queue is <code class="docutils literal notranslate"><span class="pre">in-order</span></code>, <code class="docutils literal notranslate"><span class="pre">madd</span></code> will only start when <code class="docutils literal notranslate"><span class="pre">mscale</span></code>
will finish. So the order of execution is handled by command queue.</p>
<p>There is another approach of achieve the same using single out-of-order
command queue. <code class="docutils literal notranslate"><span class="pre">out_of_order_queue</span></code> function creates a single command
queue with out of order execution enabled which means that enqueues in
the command queue can go out of order (without waiting for a previous
execution to finish).</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span><span class="o">::</span><span class="n">CommandQueue</span> <span class="n">ooo_queue</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
          <span class="n">CL_QUEUE_PROFILING_ENABLE</span> <span class="o">|</span> <span class="n">CL_QUEUE_OUT_OF_ORDER_EXEC_MODE_ENABLE</span><span class="p">);</span>
</pre></div>
</div>
<p>However, since we need that <code class="docutils literal notranslate"><span class="pre">madd</span></code> kernel only starts executing after
<code class="docutils literal notranslate"><span class="pre">mscale</span></code> has finished, <code class="docutils literal notranslate"><span class="pre">cl::event</span></code> is used to wait for <code class="docutils literal notranslate"><span class="pre">mscale</span></code> to
finish execution.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span><span class="o">::</span><span class="n">Event</span> <span class="n">event</span><span class="p">;</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">cl</span><span class="o">::</span><span class="n">Event</span><span class="o">&gt;</span> <span class="n">kernel_wait_events</span>
<span class="n">kernel_wait_events</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="n">err</span> <span class="o">=</span> <span class="n">ooo_queue</span><span class="p">.</span><span class="n">enqueueNDRangeKernel</span><span class="p">(</span><span class="n">kernel_mscale</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">global</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">));</span>

<span class="n">err</span> <span class="o">=</span> <span class="n">ooo_queue</span><span class="p">.</span><span class="n">enqueueNDRangeKernel</span><span class="p">(</span><span class="n">kernel_madd</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">global</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span>
                                          <span class="o">&amp;</span><span class="n">kernel_wait_events</span><span class="p">,</span> <span class="c1">// Event from previous call</span>
                                          <span class="k">nullptr</span><span class="p">);</span>
</pre></div>
</div>
<div class="section" id="supported-shells">
<h2>SUPPORTED SHELLS<a class="headerlink" href="#supported-shells" title="Permalink to this headline">¶</a></h2>
<table class="docutils align-center">
<colgroup>
<col style="width: 38%" />
<col style="width: 32%" />
<col style="width: 30%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>SHELL</p></th>
<th class="head"><p>Board</p></th>
<th class="head"><p>Software Version</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>xilinx_u200_qdma</p></td>
<td><p>Xilinx Alveo U200</p></td>
<td><p>Vitis 2019.2</p></td>
</tr>
<tr class="row-odd"><td><p>xilinx_u280_xdma</p></td>
<td><p>Xilinx Alveo U280</p></td>
<td><p>Vitis 2019.2</p></td>
</tr>
<tr class="row-even"><td><p>xilinx_u250_qdma</p></td>
<td><p>Xilinx Alveo U250</p></td>
<td><p>Vitis 2019.2</p></td>
</tr>
<tr class="row-odd"><td><p>xilinx_u200_xdma</p></td>
<td><p>Xilinx Alveo U200</p></td>
<td><p>Vitis 2019.2</p></td>
</tr>
<tr class="row-even"><td><p>xilinx_u250_xdma</p></td>
<td><p>Xilinx Alveo U250</p></td>
<td><p>Vitis 2019.2</p></td>
</tr>
<tr class="row-odd"><td><p>xilinx_u280-es1_xdma</p></td>
<td><p>Xilinx Alveo U280</p></td>
<td><p>Vitis 2019.2</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="design-files">
<h2>DESIGN FILES<a class="headerlink" href="#design-files" title="Permalink to this headline">¶</a></h2>
<p>Application code is located in the src directory. Accelerator binary
files will be compiled to the xclbin directory. The xclbin directory is
required by the Makefile and its contents will be filled during
compilation. A listing of all the files in this example is shown below</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">src</span><span class="o">/</span><span class="n">host</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">src</span><span class="o">/</span><span class="n">madd</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">src</span><span class="o">/</span><span class="n">mmult</span><span class="o">.</span><span class="n">cpp</span>
<span class="n">src</span><span class="o">/</span><span class="n">mscale</span><span class="o">.</span><span class="n">cpp</span>
</pre></div>
</div>
</div>
<div class="section" id="command-line-arguments">
<h2>COMMAND LINE ARGUMENTS<a class="headerlink" href="#command-line-arguments" title="Permalink to this headline">¶</a></h2>
<p>Once the environment has been configured, the application can be
executed by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">concurrent_execution</span> <span class="o">&lt;</span><span class="n">matrix_ops</span> <span class="n">XCLBIN</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="copy_buffer.html" class="btn btn-neutral float-right" title="Copy Buffer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="host.html" class="btn btn-neutral float-left" title="Host" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Xilinx Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>